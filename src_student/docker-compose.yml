version: '2.2'
services:
    app:
      build:
        context: .
        dockerfile: ./deploy/Dockerfile
      ports:
        - "8000:5000"
      environment:
        PYTHONUNBUFFERED: 1
        SENTRY_DSN: https://ee56f190321843bb94743516787f4845@o412552.ingest.sentry.io/5289504
      volumes:
        - ./app:/code

    nginx:
      image: nginx:1.19.2
      logging:
        driver: gelf
        options:
          gelf-address: udp://127.0.0.1:5044
          tag: nginx
      volumes:
        - ./deploy/etc/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
        - ./deploy/etc/nginx/conf.d:/etc/nginx/conf.d:ro
        - /tmp/logs/nginx/:/var/log/nginx/
      depends_on:
        - app
      ports:
        - 8080:80

    logstash:
      image: elastic/logstash:7.12.1
      environment:
        # Так как сейчас вы хотите запустить logstash без Elasticsearch, необходимо отключить встроенный мониторинг, отправляющий данные в ES
        XPACK_MONITORING_ENABLED: "false"
        ES_HOST: "elasticsearch:9200"
      ports:
        - "5044:5044/udp"
      volumes:
        # Монтируем файл с конфигурацией logstash
        - ./deploy/logstash.conf:/config/logstash.conf:ro
        - /tmp/logs/nginx/:/var/log/nginx/:ro

      # Запускаем с указанием конфигурационного файла
      command: logstash -f /config/logstash.conf
      depends_on:
        - elasticsearch

    elasticsearch:
      image: docker.elastic.co/elasticsearch/elasticsearch:7.10.2
      environment:
        # Указываем ES запуститься в одном экземпляре
        discovery.type: single-node
      ports:
        - 9200:9200
      volumes:
        - /tmp/esdata:/tmp/elasticsearch/data
    # Обратите внимание: не стоит использовать для ELK тот же ES, который задействован для полнотекстового поиска в вашем сервисе

    kibana:
      image: docker.elastic.co/kibana/kibana:7.10.2
      ports:
        - "5601:5601"
      depends_on:
        - elasticsearch

    filebeat:
      image: docker.elastic.co/beats/filebeat:7.3.2
      volumes:
        - /tmp/logs/nginx:/var/log/nginx:ro
        - ./deploy/filebeat.yml:/usr/share/filebeat/filebeat.yml
      depends_on:
        - app
        - nginx
        - logstash
        - elasticsearch
        - kibana
      links:
        - logstash